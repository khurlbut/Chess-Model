package strategy;

import java.util.List;

import model.Piece;
import model.board.ChessBoard;
import model.enums.Color;

class BoardInterrogator {

    private int materialGrade;
    private int territoryGrade;
    private int positionGrade;
    private int collaborationGrade;

    BoardGrade grade(ChessBoard chessBoard, Color color) {
        List<Piece> pieces = chessBoard.piecesFor(color);
        List<Piece> opponentPieces = chessBoard.piecesFor(color.opponentColor());

        interrogate(pieces, opponentPieces, chessBoard);

        return new BoardGrade(materialGrade, territoryGrade, positionGrade, collaborationGrade);
    }

    private void interrogate(List<Piece> pieces, List<Piece> opponentPieces, ChessBoard chessBoard) {
        int material = 0;
        int territory = 0;
        int collaboration = 0;
        int position = 0;

        for (Piece piece : pieces) {
            material += piece.points();
            territory += piece.threatenedSquares(chessBoard).size();
            collaboration += piece.piecesDefended(chessBoard).size();
            position += position(chessBoard, position, piece);
        }

        int opponentMaterial = 0;
        int opponentTerritory = 0;
        for (Piece opponentPiece : opponentPieces) {
            opponentMaterial += opponentPiece.points();
            opponentTerritory += opponentPiece.threatenedSquares(chessBoard).size();
        }

        this.materialGrade = material - opponentMaterial;
        this.territoryGrade = territory - opponentTerritory;
        this.collaborationGrade = collaboration;
        this.positionGrade = position;
    }

    private int position(ChessBoard chessBoard, int position, Piece piece) {
        List<Piece> attackers = piece.opponentAttackers(chessBoard);
        List<Piece> defenders = piece.collaboratorDefenders(chessBoard);

        int attackerCount = attackers.size();
        int defenderCount = defenders.size();

        if (attackerCount > 0) {
            if (defenderCount < attackerCount) {
                position -= piece.rank().value();
            } else {
                for (Piece attacker : attackers) {
                    if (attacker.rank().value() < piece.rank().value()) {
                        position -= piece.rank().value();
                    }
                }
            }
        }

        List<Piece> piecesAttacked = piece.piecesAttacked(chessBoard);
        for (Piece attackedPiece : piecesAttacked) {
            if (attackedPiece.collaboratorDefenders(chessBoard).size() == 0) {
                position += attackedPiece.rank().value();
            } else if (attackedPiece.rank().value() < piece.rank().value()) {
                position += attackedPiece.rank().value();
            }
        }
        return position;
    }

}
