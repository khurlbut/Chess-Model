package strategy;

import java.util.List;

import model.board.ChessBoard;
import model.board.GameEvent;
import model.enums.Color;

public class BruteForceGameStrategy implements GameStrategy {

    BoardInterrogator boardInterrogator = new BoardInterrogator();

    @Override
    public GameEvent nextMove(Color color, ChessBoard chessBoard) {

        MoveGrade bestCase = null;
        ChessBoard boardAfterMove = null;

        List<GameEvent> moves = chessBoard.potentialGameEvents(color);

        for (GameEvent move : moves) {
            boardAfterMove = chessBoard.playEvent(move);

            ChessBoard boardAfterResponse = null;
            MoveGrade worstCaseResponse = null;

            List<GameEvent> potentialResponses = boardAfterMove.potentialGameEvents(color.opponentColor());

            worstCaseResponse = findWorstCaseResponse(color, boardAfterMove, worstCaseResponse, potentialResponses);

            MoveGrade moveGrade = new MoveGrade(move, worstCaseResponse.grade);
            if (bestCase == null) {
                bestCase = moveGrade;
            }

            bestCase = bestCase.higherGrade(moveGrade);

        }

        return bestCase.move;
    }

    private MoveGrade findWorstCaseResponse(Color color, ChessBoard boardAfterMove, MoveGrade worstCaseResponse,
        List<GameEvent> potentialResponses) {
        ChessBoard boardAfterResponse;
        for (GameEvent moveResponse : potentialResponses) {
            boardAfterResponse = boardAfterMove.playEvent(moveResponse);

            BoardGrade grade = boardInterrogator.grade(boardAfterResponse, color);
            MoveGrade responseGrade = new MoveGrade(moveResponse, grade);

            if (worstCaseResponse == null) {
                worstCaseResponse = responseGrade;
            }

            worstCaseResponse = worstCaseResponse.lowerGrade(responseGrade);
        }
        return worstCaseResponse;
    }

    private class MoveGrade {
        private GameEvent move;
        private BoardGrade grade;

        public MoveGrade(GameEvent moveResponse, BoardGrade grade) {
            this.move = moveResponse;
            this.grade = grade;
        }

        public MoveGrade higherGrade(MoveGrade otherGrade) {
            return new MoveGrade(move, grade.higherGrade(otherGrade.grade));
        }

        public MoveGrade lowerGrade(MoveGrade otherGrade) {
            return new MoveGrade(move, grade.lowerGrade(otherGrade.grade));
        }

    }

}
